From 64e90a48b2c4990ad9fad9149d0b0a89a60dd8e6 Mon Sep 17 00:00:00 2001
From: HL21029-Student <hl21029@ues.edu.sv>
Date: Tue, 18 Nov 2025 00:44:12 -0600
Subject: [PATCH] Se soluciono problemas con Pinia

---
 package-lock.json                | 49 ++++++++++++++++++++++++++++++++
 src/boot/firebase.js             | 16 +++++++++--
 src/boot/pinia.js                | 38 +++++++++++++++++++++++++
 src/composables/useCart.js       | 13 +++++----
 src/layouts/MainLayout.vue       |  9 ++++--
 src/pages/IndexPage.vue          | 48 ++-----------------------------
 src/services/celularesService.js |  5 +++-
 src/stores/cartStore.js          | 10 +------
 8 files changed, 121 insertions(+), 67 deletions(-)

diff --git a/package-lock.json b/package-lock.json
index 27355b3..3eb408b 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -12,6 +12,7 @@
         "@quasar/extras": "^1.16.4",
         "chart.js": "^4.5.1",
         "firebase": "^12.6.0",
+        "pinia": "^2.1.7",
         "quasar": "^2.16.0",
         "vue": "^3.5.22",
         "vue-router": "^4.0.0"
@@ -6155,6 +6156,28 @@
         "url": "https://github.com/sponsors/jonschlinkert"
       }
     },
+    "node_modules/pinia": {
+      "version": "2.3.1",
+      "resolved": "https://registry.npmjs.org/pinia/-/pinia-2.3.1.tgz",
+      "integrity": "sha512-khUlZSwt9xXCaTbbxFYBKDc/bWAGWJjOgvxETwkTN7KRm66EeT1ZdZj6i2ceh9sP2Pzqsbc704r2yngBrxBVug==",
+      "license": "MIT",
+      "dependencies": {
+        "@vue/devtools-api": "^6.6.3",
+        "vue-demi": "^0.14.10"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/posva"
+      },
+      "peerDependencies": {
+        "typescript": ">=4.4.4",
+        "vue": "^2.7.0 || ^3.5.11"
+      },
+      "peerDependenciesMeta": {
+        "typescript": {
+          "optional": true
+        }
+      }
+    },
     "node_modules/pkg-types": {
       "version": "1.3.1",
       "resolved": "https://registry.npmjs.org/pkg-types/-/pkg-types-1.3.1.tgz",
@@ -8134,6 +8157,32 @@
         }
       }
     },
+    "node_modules/vue-demi": {
+      "version": "0.14.10",
+      "resolved": "https://registry.npmjs.org/vue-demi/-/vue-demi-0.14.10.tgz",
+      "integrity": "sha512-nMZBOwuzabUO0nLgIcc6rycZEebF6eeUfaiQx9+WSk8e29IbLvPU9feI6tqW4kTo3hvoYAJkMh8n8D0fuISphg==",
+      "hasInstallScript": true,
+      "license": "MIT",
+      "bin": {
+        "vue-demi-fix": "bin/vue-demi-fix.js",
+        "vue-demi-switch": "bin/vue-demi-switch.js"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/antfu"
+      },
+      "peerDependencies": {
+        "@vue/composition-api": "^1.0.0-rc.1",
+        "vue": "^3.0.0-0 || ^2.6.0"
+      },
+      "peerDependenciesMeta": {
+        "@vue/composition-api": {
+          "optional": true
+        }
+      }
+    },
     "node_modules/vue-eslint-parser": {
       "version": "10.2.0",
       "resolved": "https://registry.npmjs.org/vue-eslint-parser/-/vue-eslint-parser-10.2.0.tgz",
diff --git a/src/boot/firebase.js b/src/boot/firebase.js
index 7c6fd5b..3b8b45a 100644
--- a/src/boot/firebase.js
+++ b/src/boot/firebase.js
@@ -19,12 +19,22 @@ const db = getFirestore(app)
 
 export default boot(({ app }) => {
   app.config.globalProperties.$db = db
+  console.log('üî• Firebase inicializado correctamente')
+  console.log('üìä Configuraci√≥n:', {
+    projectId: firebaseConfig.projectId,
+    hasApiKey: !!firebaseConfig.apiKey,
+  })
 
   // Inicializa los productos si la base de datos est√° vac√≠a
   // Lo ejecutamos sin 'await' para no bloquear la carga de la aplicaci√≥n.
-  celularesService.initializeProductos().catch((error) => {
-    console.error('Error al inicializar productos en el arranque:', error)
-  })
+  celularesService
+    .initializeProductos()
+    .then(() => {
+      console.log('‚úÖ Inicializaci√≥n de productos completada')
+    })
+    .catch((error) => {
+      console.error('‚ùå Error al inicializar productos en el arranque:', error)
+    })
 })
 
 export { db }
diff --git a/src/boot/pinia.js b/src/boot/pinia.js
index b057b05..6bd04fa 100644
--- a/src/boot/pinia.js
+++ b/src/boot/pinia.js
@@ -1,7 +1,45 @@
 import { boot } from 'quasar/wrappers'
 import { createPinia } from 'pinia'
+import { useCartStore } from 'src/stores/cartStore'
+
+// --- INICIO: L√≥gica para optimizar la escritura en localStorage ---
+
+// Funci√≥n para guardar el estado del carrito en el LocalStorage.
+function saveCartToLocalStorage(state) {
+  localStorage.setItem('cartItems', JSON.stringify(state.cartItems))
+}
+
+// Funci√≥n "debounce". Retrasa la ejecuci√≥n de una funci√≥n hasta que haya pasado
+// un tiempo determinado sin que se vuelva a llamar.
+function debounce(func, timeout = 300) {
+  let timer
+  return (...args) => {
+    clearTimeout(timer)
+    timer = setTimeout(() => {
+      func.apply(this, args)
+    }, timeout)
+  }
+}
+
+// Creamos una versi√≥n "debounced" de nuestra funci√≥n de guardado.
+// Solo se ejecutar√° 300ms despu√©s del √∫ltimo cambio en el carrito.
+const debouncedSave = debounce((state) => saveCartToLocalStorage(state))
+
+// --- FIN: L√≥gica de optimizaci√≥n ---
 
 export default boot(({ app }) => {
   const pinia = createPinia()
   app.use(pinia)
+
+  // Obtenemos la instancia del store del carrito.
+  const cartStore = useCartStore(pinia)
+
+  // Usamos $watch para observar cambios en el estado del store.
+  // Cada vez que `cartItems` cambie, llamaremos a nuestra funci√≥n optimizada.
+  cartStore.$subscribe((mutation, state) => {
+    // `mutation.storeId` nos asegura que solo reaccionamos a cambios en el store 'cart'.
+    if (mutation.storeId === 'cart') {
+      debouncedSave(state)
+    }
+  })
 })
diff --git a/src/composables/useCart.js b/src/composables/useCart.js
index 65fddc3..2eaf009 100644
--- a/src/composables/useCart.js
+++ b/src/composables/useCart.js
@@ -1,9 +1,10 @@
+import { computed } from 'vue'
 import { useQuasar } from 'quasar'
 import { useCartStore } from 'src/stores/cartStore'
 
-// Composable del carrito (adaptador sobre Pinia)
 export const useCart = () => {
   const $q = useQuasar()
+
   const store = useCartStore()
 
   const addToCart = (product) => {
@@ -68,14 +69,14 @@ export const useCart = () => {
   }
 
   return {
-    cartItems: store.cartItems,
+    cartItems: computed(() => store.cartItems),
     addToCart,
     removeFromCart,
     updateQuantity,
     clearCart,
-    subtotal: store.subtotal,
-    envio: store.envio,
-    total: store.total,
-    totalItems: store.totalItems,
+    subtotal: computed(() => store.subtotal),
+    envio: computed(() => store.envio),
+    total: computed(() => store.total),
+    totalItems: computed(() => store.totalItems),
   }
 }
diff --git a/src/layouts/MainLayout.vue b/src/layouts/MainLayout.vue
index ac3d81d..55a89fc 100644
--- a/src/layouts/MainLayout.vue
+++ b/src/layouts/MainLayout.vue
@@ -235,7 +235,7 @@
     </q-page-container>
 
     <!-- Di√°logo para crear producto -->
-    <CrearProductoDialog v-model="showCrearProductoDialog" @productoCreado="cargarProductos" />
+    <CrearProductoDialog v-model="showCrearProductoDialog" @productoCreado="cargarProductos()" />
   </q-layout>
 </template>
 
@@ -305,7 +305,9 @@ export default {
     const cargarProductos = async () => {
       try {
         loading.value = true
+        console.log('üîÑ Cargando productos desde Firebase...')
         const data = await celularesService.getCelulares()
+        console.log('‚úÖ Productos recibidos:', data.length, data)
         products.value = data.map((p) => ({
           id: p.id,
           name: p.tituloAnuncio || 'Sin t√≠tulo',
@@ -319,10 +321,11 @@ export default {
           isNew: p.estado === 'nuevo',
           createdAt: p.fechaCreacion ? new Date(p.fechaCreacion).getTime() : 0,
         }))
+        console.log('üì¶ Productos mapeados:', products.value.length)
       } catch (error) {
-        console.error('Error cargando productos:', error)
+        console.error('‚ùå Error cargando productos:', error)
         $q.notify({
-          message: 'Error al cargar los productos',
+          message: 'Error al cargar los productos: ' + error.message,
           color: 'negative',
           position: 'top',
           icon: 'error',
diff --git a/src/pages/IndexPage.vue b/src/pages/IndexPage.vue
index 4fad713..210f29a 100644
--- a/src/pages/IndexPage.vue
+++ b/src/pages/IndexPage.vue
@@ -1,54 +1,12 @@
 <template>
-  <q-page class="flex flex-center">
-    <div v-if="loading">Cargando productos...</div>
-    <div v-else-if="error">{{ error }}</div>
-    <div v-else-if="celulares.length > 0">
-      <q-list bordered separator>
-        <q-item v-for="celular in celulares" :key="celular.id">
-          <q-item-section avatar>
-            <q-img
-              :src="celular.imagen || celular.imagenes?.[0] || 'https://via.placeholder.com/80'"
-              style="width: 80px; height: 80px; object-fit: cover"
-            />
-          </q-item-section>
-          <q-item-section>
-            <q-item-label>{{ celular.marca }} {{ celular.modelo }}</q-item-label>
-            <q-item-label caption>{{ celular.tituloAnuncio }}</q-item-label>
-            <q-item-label caption>Precio: ${{ celular.precio }}</q-item-label>
-          </q-item-section>
-        </q-item>
-      </q-list>
-    </div>
-    <div v-else>No hay productos disponibles.</div>
-  </q-page>
+  <!-- Este componente ahora est√° vac√≠o porque MainLayout.vue se encarga de mostrar el contenido. -->
+  <q-page> </q-page>
 </template>
 
 <script>
-import { defineComponent, ref, onMounted } from 'vue'
-import { celularesService, celularesData, loadingCelulares } from 'src/services/celularesService'
+import { defineComponent } from 'vue'
 
 export default defineComponent({
   name: 'IndexPage',
-  setup() {
-    const error = ref(null)
-
-    onMounted(async () => {
-      try {
-        // Solo cargar si no hay datos a√∫n
-        if (celularesData.value.length === 0) {
-          await celularesService.getCelulares()
-        }
-      } catch (err) {
-        error.value = 'Error al cargar los productos: ' + err.message
-        console.error(err)
-      }
-    })
-
-    return {
-      celulares: celularesData,
-      loading: loadingCelulares,
-      error,
-    }
-  },
 })
 </script>
diff --git a/src/services/celularesService.js b/src/services/celularesService.js
index dfa9346..cfac860 100644
--- a/src/services/celularesService.js
+++ b/src/services/celularesService.js
@@ -12,7 +12,9 @@ export const celularesService = {
   async getCelulares() {
     try {
       loadingCelulares.value = true
+      console.log('üì° Conectando a Firebase...')
       const querySnapshot = await getDocs(celularesCollection())
+      console.log('üì• Documentos encontrados:', querySnapshot.docs.length)
       const productos = querySnapshot.docs.map((doc) => ({
         id: doc.id,
         ...doc.data(),
@@ -26,9 +28,10 @@ export const celularesService = {
       })
 
       celularesData.value = productos
+      console.log('‚úÖ Productos cargados y ordenados:', productos.length)
       return productos
     } catch (error) {
-      console.error('Error obteniendo celulares:', error)
+      console.error('‚ùå Error obteniendo celulares:', error)
       throw error
     } finally {
       loadingCelulares.value = false
diff --git a/src/stores/cartStore.js b/src/stores/cartStore.js
index 59c6ccb..f757a62 100644
--- a/src/stores/cartStore.js
+++ b/src/stores/cartStore.js
@@ -1,5 +1,6 @@
 import { defineStore } from 'pinia'
 
+// Clave para guardar y cargar el carrito desde el LocalStorage del navegador.
 const STORAGE_KEY = 'cartItems'
 
 function loadFromLocalStorage() {
@@ -10,10 +11,6 @@ function loadFromLocalStorage() {
   }
 }
 
-function saveToLocalStorage(items) {
-  localStorage.setItem(STORAGE_KEY, JSON.stringify(items))
-}
-
 export const useCartStore = defineStore('cart', {
   state: () => ({
     cartItems: loadFromLocalStorage(),
@@ -23,7 +20,6 @@ export const useCartStore = defineStore('cart', {
       return state.cartItems.reduce((total, item) => total + item.price * item.quantity, 0)
     },
     envio() {
-      // Using getter context via this to access other getters
       return this.subtotal > 500 ? 0 : 25
     },
     total() {
@@ -42,12 +38,10 @@ export const useCartStore = defineStore('cart', {
       } else {
         this.cartItems.push({ ...product, quantity: 1 })
       }
-      saveToLocalStorage(this.cartItems)
     },
     removeFromCart(index) {
       if (index < 0 || index >= this.cartItems.length) return
       this.cartItems.splice(index, 1)
-      saveToLocalStorage(this.cartItems)
     },
     updateQuantity(itemId, newQuantity) {
       const idx = this.cartItems.findIndex((i) => i.id === itemId)
@@ -57,11 +51,9 @@ export const useCartStore = defineStore('cart', {
         return
       }
       this.cartItems[idx].quantity = newQuantity
-      saveToLocalStorage(this.cartItems)
     },
     clearCart() {
       this.cartItems = []
-      saveToLocalStorage(this.cartItems)
     },
   },
 })
-- 
2.51.0.windows.1

